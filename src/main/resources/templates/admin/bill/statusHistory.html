<!DOCTYPE html>
<html lang="en">
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Lịch sử thao tác</title>
</head>
<body>
<h1 align="center">Lịch sử thay đổi trạng thái hóa đơn</h1>
<div layout:fragment="content">

    <table class="table table-hover border my-3" style="cursor: pointer" id="history" th:with="historyData=${historyData}">
        <thead class="thead-dark">
        <tr>
            <th scope="col">Thời gian chỉnh sửa
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'code' && sortDirection == 'asc' ? 'code,desc' : 'code,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'code' && sortDirection == 'desc' ? 'code,asc' : 'code,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
            <th scope="col">Mã hóa đơn
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'code' && sortDirection == 'asc' ? 'code,desc' : 'code,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'code' && sortDirection == 'desc' ? 'code,asc' : 'code,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
            <th scope="col">Người thay đổi
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'customerName' && sortDirection == 'asc' ? 'customerName,desc' : 'customerName,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'customerName' && sortDirection == 'desc' ? 'customerName,asc' : 'customerName,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
            <th scope="col">Trạng thái trước
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'phoneNumber' && sortDirection == 'asc' ? 'phoneNumber,desc' : 'phoneNumber,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'phoneNumber' && sortDirection == 'desc' ? 'phoneNumber,asc' : 'phoneNumber,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
            <th scope="col">Trạng thái sau
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'createDate' && sortDirection == 'asc' ? 'createDate,desc' : 'createDate,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'createDate' && sortDirection == 'desc' ? 'createDate,asc' : 'createDate,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
            <th scope="col">Ghi chú
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'totalPrice' && sortDirection == 'asc' ? 'totalPrice,desc' : 'totalPrice,asc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↑</a>
                <a th:href="@{/tiger/bill(page=0, sort=${sortField == 'totalPrice' && sortDirection == 'desc' ? 'totalPrice,asc' : 'totalPrice,desc'}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="sort-link">↓</a>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="entry : ${historyData}">
            <td th:text="${entry.time}"></td>
            <td th:text="${entry.prevStatus}"></td>
            <td th:text="${entry.newStatus}"></td>
            <td th:text="${entry.user}"></td>
            <td th:text="${entry.reason}"></td>
        </tr>
        </tr>
        </tbody>
    </table>

    <div class="clearfix float-right" th:if="${items.totalPages > 0}">
        <ul class="pagination">
            <li th:classappend="${items.hasPrevious() ? '' : 'disabled'}" class="page-item">
                <a th:href="@{/tiger/bill(page=0, sort=${sortField}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="page-link">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li th:classappend="${items.hasPrevious() ? '' : 'disabled'}" class="page-item">
                <a th:href="@{/tiger/bill(page=${items.number - 1}, sort=${sortField}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="page-link">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            <li th:each="i : ${#numbers.sequence(0, items.totalPages - 1)}" th:classappend="${i == items.number ? 'active' : ''}" class="page-item">
                <a th:href="@{/tiger/bill(page=${i}, sort=${sortField}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}" class="page-link" th:text="${i + 1}">
                </a>
            </li>
            <li th:classappend="${items.hasNext() ? '' : 'disabled'}" class="page-item">
                <a th:href="@{/tiger/bill(page=${items.number + 1}, sort=${sortField}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="page-link">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li th:classappend="${items.hasNext() ? '' : 'disabled'}" class="page-item">
                <a th:href="@{/tiger/bill(page=${items.totalPages - 1},sort=${sortField}, code=${code}, ngayTaoStart=${ngayTaoStart}, ngayTaoEnd=${ngayTaoEnd}, status=${status}, type=${type}, customerName=${customerName}, phoneNumber=${phoneNumber})}"
                   class="page-link">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
        </ul>
    </div>

    <script th:inline="javascript">
        var historyData = [[${historyData}]];
        // Function to add history entry
        function addHistoryEntry(prevStatus, newStatus, user, reason) {
            var currentTime = new Date().toLocaleString(); // Get current time
            historyData.push({
                time: currentTime,
                prevStatus: prevStatus,
                newStatus: newStatus,
                user: user,
                reason: reason
            });
            updateHistoryTable();
        }

        // Function to update the history table
        function updateHistoryTable() {
            var historyTable = document.getElementById("historyTable").getElementsByTagName("tbody")[0];
            historyTable.innerHTML = ''; // Clear previous entries

            historyData.forEach(function(entry) {
                var row = historyTable.insertRow();
                var timeCell = row.insertCell();
                var prevStatusCell = row.insertCell();
                var newStatusCell = row.insertCell();
                var userCell = row.insertCell();
                var reasonCell = row.insertCell();

                timeCell.innerHTML = entry.time;
                prevStatusCell.innerHTML = entry.prevStatus;
                newStatusCell.innerHTML = entry.newStatus;
                userCell.innerHTML = entry.user;
                reasonCell.innerHTML = entry.reason || '-'; // Display '-' if no reason
            });
        }


        // check ngày hợp lệ
        $(document).ready(function () {
            $('#form-search').on('submit', function (e) {
                if($('#ngayTaoStart').val() && $('#ngayTaoEnd').val()) {
                    if( $('#ngayTaoEnd').val() < $('#ngayTaoStart').val()) {
                        Swal.fire({
                            title: "Lỗi",
                            text: `Ngày kết thúc phải lớn hơn ngày bắt đầu`,
                            icon: "error",
                        })
                        return false
                    }
                }
                return true;
            })

            //button hủy đơn
            $('.cancel-btn').on('click', function (e) {
                e.preventDefault();
                // Create a text area for the reason
                const reasonTextArea = document.createElement('textarea');
                reasonTextArea.placeholder = 'Nhập lý do hủy đơn';
                reasonTextArea.style.width = '100%';
                reasonTextArea.style.height = '80px';

                Swal.fire({
                    title: "Xác nhận?",
                    text: `Bạn chắc chắn muốn hủy đơn này?`,
                    icon: "warning",
                    showCancelButton: true,
                    html: `<p>Lý do hủy đơn:</p>
                       ${reasonTextArea.outerHTML}`,
                    cancelButtonText: 'Hủy',
                    confirmButtonText: 'Xác nhận',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        const reason = reasonTextArea.value;

                        // Add the reason to the URL if needed
                        const url = $(this).attr('href');
                        const updatedUrl = reason ? `${url}?reason=${encodeURIComponent(reason)}` : url;
                        window.location.href = $(this).attr('href');
                    }
                })
            });

            //button xác nhận đơn hàng
            $('.confirm-btn').on('click', function (e) {
                e.preventDefault();

                const reasonTextArea = document.createElement('textarea');
                reasonTextArea.placeholder = 'Nhập lý do hủy đơn';
                reasonTextArea.style.width = '100%';
                reasonTextArea.style.height = '80px';

                Swal.fire({
                    title: "Xác nhận?",
                    text: "Xác nhận đơn hàng này?",
                    html: `\`<p>Ghi chú:</p>
                       ${reasonTextArea.outerHTML}\``,
                    icon: "warning",
                    showCancelButton: true,
                    cancelButtonText: 'Hủy',
                    confirmButtonText: 'Xác nhận',
                    reverseButtons: true,
                    preConfirm: () => {
                        moTa = document.getElementById('moTaInput').value;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const reason = reasonTextArea.value;

                        // Add the reason to the URL if needed
                        const url = $(this).attr('href');
                        const updatedUrl = reason ? `${url}?reason=${encodeURIComponent(reason)}` : url;
                        window.location.href = $(this).attr('href');
                    }
                })})
        });

        //button xác nhân giao đon hàng
        $('.shipping-btn').on('click', function (e) {
            e.preventDefault();
            Swal.fire({
                title: "Xác nhận?",
                text: `Xác nhận giao đơn này?`,
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: 'Hủy',
                confirmButtonText: 'Xác nhận',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = $(this).attr('href');
                }
            })
        });

        $('.complete-btn').on('click', function (e) {
            e.preventDefault();
            Swal.fire({
                title: "Xác nhận?",
                text: `Xác nhận đã giao thành công đơn này?`,
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: 'Hủy',
                confirmButtonText: 'Xác nhận',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = $(this).attr('href');
                }
            })
        });

        })
        var lastClickTime = 0;
        var doubleClickDelay = 300;

        var clickableRows = document.querySelectorAll(".clickable-row");

        clickableRows.forEach(function(row) {
            row.addEventListener("click", function(e) {
                var currentTime = new Date().getTime();
                if (currentTime - lastClickTime < doubleClickDelay) {
                    // Đây là double click
                    var maHoaDon = row.getAttribute("data-maHoaDon");
                    window.location.href = "/tiger/bill/detail/" + maHoaDon;
                }
                lastClickTime = currentTime;
            });
        });

        function exportToExcel() {
            var page = document.getElementById("pageValue").value;
            var sort = document.getElementById("sortValue").value;
            var ngayTaoStart = document.getElementById("ngayTaoStart").value;
            var ngayTaoEnd = document.getElementById("ngayTaoEnd").value;

            Swal.fire({
                title: "Xác nhận?",
                text: `Xác nhận export file excel?`,
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: 'Hủy',
                confirmButtonText: 'Xác nhận',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    var exportUrl = `/tiger/bill/export-bill?page=${page}&sort=${sort}&ngayTaoStart=${ngayTaoStart}&ngayTaoEnd=${ngayTaoEnd}`;
                    window.location.href = exportUrl;
                }
            });
        }

    </script>

</div>

</body>
</html>